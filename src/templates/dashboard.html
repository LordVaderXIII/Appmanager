{% extends "layout.html" %}

{% block title %}Dashboard - App Manager{% endblock %}

{% block content %}

<style>
    .tab-container {
        margin-bottom: 1rem;
    }
    .tab-header {
        display: flex;
        border-bottom: 1px solid #ddd;
    }
    .tab-btn {
        padding: 0.75rem 1.5rem;
        cursor: pointer;
        background: none;
        border: none;
        border-bottom: 3px solid transparent;
        font-weight: bold;
        color: #666;
    }
    .tab-btn.active {
        border-bottom-color: #007bff;
        color: #007bff;
    }
    .tab-content {
        display: none;
        padding-top: 1rem;
    }
    .tab-content.active {
        display: block;
    }
    .hidden {
        display: none;
    }
    .action-group {
        display: flex;
        gap: 5px;
        align-items: center;
    }
    .btn-log {
        background-color: #17a2b8;
        color: white;
        text-decoration: none;
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
        border-radius: 0.25rem;
        display: inline-block;
        line-height: 1.5;
    }
    .btn-log:hover {
        background-color: #138496;
    }
</style>

<div class="card">
    <h2>Add Application</h2>

    <div class="tab-container">
        <div class="tab-header">
            <button class="tab-btn active" onclick="openTab('new-app')">New App</button>
            <button class="tab-btn" onclick="openTab('link-app')">Link Existing Container</button>
        </div>

        <div id="new-app" class="tab-content active">
            <form action="/repos" method="post" style="display: flex; gap: 10px; flex-direction: column;">
                <p style="color: #666; font-size: 0.9rem;">
                    Deploy a new application from a GitHub repository. We'll automatically configure ports and storage for Unraid.
                </p>
                <div style="display: flex; gap: 10px;">
                    <input type="text" name="url" placeholder="https://github.com/user/repo.git" required style="margin-bottom: 0; flex-grow: 1;">
                    <button type="submit" class="primary">Deploy New App</button>
                </div>
            </form>
        </div>

        <div id="link-app" class="tab-content">
             <form action="/repos" method="post" style="display: flex; gap: 10px; flex-direction: column;">
                <p style="color: #666; font-size: 0.9rem;">
                    Link a running Docker container to a GitHub repository to enable automatic updates and management.
                </p>

                <label for="container-select">Select Running Container:</label>
                <select id="container-select" name="link_container_id" onchange="previewContainer()" required style="width: 100%; padding: 0.5rem; margin-bottom: 1rem;">
                    <option value="">Loading containers...</option>
                </select>

                <div id="container-preview" class="hidden" style="background: #f9f9f9; padding: 1rem; border-radius: 4px; margin-bottom: 1rem; font-size: 0.9rem;">
                    <strong>Details to be adopted:</strong>
                    <ul style="margin: 0.5rem 0 0 1.5rem; padding: 0;">
                        <li>Ports: <span id="preview-ports"></span></li>
                        <li>Volumes: <span id="preview-volumes"></span></li>
                    </ul>
                </div>

                <div style="display: flex; gap: 10px;">
                    <input type="text" name="url" placeholder="https://github.com/user/repo.git" required style="margin-bottom: 0; flex-grow: 1;">
                    <button type="submit" class="primary">Link & Manage</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="card">
    <div class="flex-row">
        <h2>Monitored Repositories</h2>
        <form action="/repos/trigger" method="post" style="margin: 0;">
            <button type="submit" class="secondary">Check Updates Now</button>
        </form>
    </div>

    <table>
        <thead>
            <tr>
                <th>Name</th>
                <th>Container</th>
                <th>URL</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for repo in repos %}
            <tr>
                <td>{{ repo.name }}</td>
                <td><small>{{ repo.container_name or '-' }}</small></td>
                <td><a href="{{ repo.url }}" target="_blank" style="color: #007bff; text-decoration: none;">{{ repo.url }}</a></td>
                <td class="status-{{ repo.status }}">{{ repo.status|capitalize }}</td>
                <td>
                    <div class="action-group">
                        <a href="/repos/{{ repo.id }}/logs/build" target="_blank" class="btn-log">Logs</a>
                        <form action="/repos/{{ repo.id }}/delete" method="post" onsubmit="return confirm('Are you sure you want to delete {{ repo.name }}?');" style="margin: 0;">
                            <button type="submit" class="danger" style="padding: 0.25rem 0.5rem; font-size: 0.875rem;">Remove</button>
                        </form>
                    </div>
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="5" style="text-align: center; color: #777; padding: 2rem;">No repositories added yet.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<script>
    function openTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        event.currentTarget.classList.add('active');

        if (tabId === 'link-app') {
            loadContainers();
        }
    }

    async function loadContainers() {
        const select = document.getElementById('container-select');
        select.innerHTML = '<option value="">Loading...</option>';

        try {
            const response = await fetch('/docker/containers');
            const containers = await response.json();

            select.innerHTML = '<option value="">-- Select a Container --</option>';
            containers.forEach(c => {
                const option = document.createElement('option');
                option.value = c.id;
                option.text = `${c.name} (${c.image})`;
                select.appendChild(option);
            });
        } catch (e) {
            select.innerHTML = '<option value="">Error loading containers</option>';
            console.error(e);
        }
    }

    async function previewContainer() {
        const id = document.getElementById('container-select').value;
        const preview = document.getElementById('container-preview');

        if (!id) {
            preview.classList.add('hidden');
            return;
        }

        try {
            const response = await fetch(`/docker/containers/${id}`);
            const data = await response.json();

            document.getElementById('preview-ports').textContent = JSON.stringify(data.ports);
            document.getElementById('preview-volumes').textContent = Object.keys(data.volumes).join(', ');
            preview.classList.remove('hidden');
        } catch (e) {
            console.error(e);
        }
    }
</script>
{% endblock %}
