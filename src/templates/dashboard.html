{% extends "layout.html" %}

{% block title %}Dashboard - App Manager{% endblock %}

{% block content %}

<div class="header-large">
    <h1>Dashboard</h1>
</div>

<div class="list-group">
    <div class="list-item">
        <span style="font-weight: 600; font-size: 17px;">Monitored Repositories</span>
        <form action="/repos/trigger" method="post" style="margin: 0;">
            <button type="submit" class="btn-secondary small">Check Updates</button>
        </form>
    </div>
</div>

<div class="list-group">
    {% for repo in repos %}
    <div class="list-item">
        <div style="flex: 1; min-width: 0; padding-right: 15px;">
            <div style="font-weight: 600; font-size: 16px; margin-bottom: 2px;">{{ repo.name }}</div>
            <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                {{ repo.url }}
            </div>
            <div style="display: flex; align-items: center; gap: 8px;">
                <span class="status-{{ repo.status }}" style="font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">
                    {{ repo.status }}
                </span>
                {% if repo.container_name %}
                <span style="font-size: 12px; color: var(--text-secondary);">â€¢ {{ repo.container_name }}</span>
                {% endif %}
            </div>
        </div>

        <div style="display: flex; gap: 10px; align-items: center;">
            {% if repo.web_port %}
            <a href="http://{{ request.url.hostname }}:{{ repo.web_port }}" target="_blank" class="btn-secondary small">
                Open
            </a>
            {% endif %}

            <a href="#" onclick="openLogsModal({{ repo.id }}, '{{ repo.name }}'); return false;" style="color: var(--text-secondary); padding: 5px;">
                <svg viewBox="0 0 24 24" width="22" height="22" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
            </a>

            <form action="/repos/{{ repo.id }}/delete" method="post" onsubmit="return confirm('Are you sure you want to delete {{ repo.name }}?');" style="margin: 0;">
                <button type="submit" class="btn-danger">
                    <svg viewBox="0 0 24 24" width="22" height="22" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                </button>
            </form>
        </div>
    </div>
    {% else %}
    <div class="list-item" style="justify-content: center; padding: 30px; color: var(--text-secondary);">
        No repositories added yet. Tap "Add App" to get started.
    </div>
    {% endfor %}
</div>

<!-- Log Modal -->
<div id="log-modal" class="modal">
    <div class="modal-content" style="max-width: 900px; height: 80vh; display: flex; flex-direction: column;">
        <div class="modal-header">
            <h2 id="log-modal-title" style="margin:0; font-size: 18px;">Logs</h2>
            <span class="close-modal" onclick="closeLogsModal()" style="font-size: 24px;">&times;</span>
        </div>

        <pre id="log-content" class="log-viewer" style="flex: 1; margin: 0; border: none; border-radius: 0;">Loading logs...</pre>

        <div class="modal-footer" style="background-color: var(--bg-tertiary);">
             <button type="button" class="btn-secondary small" onclick="fetchLogs()">Refresh</button>
             <button type="button" class="btn-secondary small" onclick="downloadLogs()">Download</button>
             <button type="button" class="btn-primary" onclick="closeLogsModal()" style="padding: 6px 16px; font-size: 14px;">Done</button>
        </div>
    </div>
</div>

<script>
    let currentRepoId = null;
    let currentRepoName = null;

    function openLogsModal(repoId, repoName) {
        currentRepoId = repoId;
        currentRepoName = repoName;
        document.getElementById('log-modal-title').innerText = repoName;
        document.getElementById('log-modal').style.display = "block";
        fetchLogs();
    }

    function closeLogsModal() {
        document.getElementById('log-modal').style.display = "none";
        currentRepoId = null;
        document.getElementById('log-content').innerText = "Loading logs...";
    }

    async function fetchLogs() {
        if (!currentRepoId) return;
        const viewer = document.getElementById('log-content');

        try {
            const res = await fetch(`/repos/${currentRepoId}/logs/build`);
            if (res.ok) {
                const text = await res.text();
                viewer.innerText = text || "No logs available.";
                viewer.scrollTop = viewer.scrollHeight;
            } else {
                viewer.innerText = "Failed to load logs.";
            }
        } catch (e) {
            viewer.innerText = "Error fetching logs: " + e.message;
        }
    }

    function downloadLogs() {
        if (!currentRepoId) return;
        const text = document.getElementById('log-content').innerText;
        const blob = new Blob([text], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${currentRepoName || 'repo'}_build.log`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    // Close modal on outside click
    window.onclick = function(event) {
        if (event.target == document.getElementById('log-modal')) {
            closeLogsModal();
        }
    }
</script>
{% endblock %}
